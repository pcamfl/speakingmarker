<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pearson Edexcel GCSE Speaking Marker</title>
    <style>
        :root {
            --pearson-blue: #005a70;
            --pearson-dark: #004353;
            --pearson-green: #007f4f;
            --pearson-red: #d32f2f;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-col: #ccc;
            --header-bg: #e3f2fd;
            --setup-bg: #eef2f5;
            --footer-bg: #e3f2fd;
            --input-bg: #ffffff;
            --input-text: #000000;
            --timer-idle: #e2e6ea;
            --timer-running: #d4edda;
            --timer-text-running: #155724;
            --timer-paused: #fff3cd;
            --timer-text-paused: #856404;
            --timer-ended: #f8d7da;
            --timer-text-ended: #721c24;
            --btn-sec-bg: #6c757d;
            --btn-sec-text: #ffffff;
            --rubric-bg: #fafafa;
            /* Table specific - optimized for Excel copy/paste */
            --th-bg: #ffffff;
            --th-text: #000000;
            --table-row-even: #f8f9fa;
        }

        [data-theme="dark"] {
            --pearson-blue: #4db6ac;
            --pearson-dark: #80cbc4;
            --pearson-green: #66bb6a;
            --pearson-red: #ef5350;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-col: #444;
            --header-bg: #263238;
            --setup-bg: #263238;
            --footer-bg: #263238;
            --input-bg: #333;
            --input-text: #e0e0e0;
            --timer-idle: #424242;
            --timer-running: #1b5e20;
            --timer-text-running: #a5d6a7;
            --timer-paused: #f57f17;
            --timer-text-paused: #fff9c4;
            --timer-ended: #b71c1c;
            --timer-text-ended: #ffcdd2;
            --btn-sec-bg: #555;
            --btn-sec-text: #e0e0e0;
            --rubric-bg: #2c2c2c;
            /* Keep table headers light even in dark mode for Excel compatibility intent, 
               or invert for viewing but rely on raw copy for excel. 
               User requested easy visibility in Excel, so we force white bg/black text on table headers always. */
            --th-bg: #ffffff; 
            --th-text: #000000;
            --table-row-even: #2c2c2c;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-color); color: var(--text-color); padding: 20px; font-size: 14px; 
            padding-bottom: 220px; /* Space for large fixed footer */
            transition: background 0.3s, color 0.3s;
        }
        .container { 
            max-width: 1600px; margin: 0 auto; background: var(--card-bg); 
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        }
        
        /* Headers */
        h1 { color: var(--pearson-blue); margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid var(--border-col); display: flex; justify-content: space-between; align-items: center; }
        
        .theme-toggle { background: none; border: 1px solid var(--border-col); padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 1.2rem; color: var(--text-color); }
        .theme-toggle:hover { background: var(--timer-idle); }

        details.setup-panel { background: var(--setup-bg); border: 1px solid var(--border-col); padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        details.setup-panel summary { cursor: pointer; font-weight: bold; color: var(--pearson-blue); }
        textarea { width: 100%; height: 100px; margin-top: 5px; padding: 10px; border: 1px solid var(--border-col); border-radius: 4px; font-family: monospace; background: var(--input-bg); color: var(--input-text); }
        
        .header-panel { 
            display: flex; gap: 20px; background: var(--header-bg); padding: 20px; border-radius: 6px; 
            align-items: flex-end; margin-bottom: 20px; border-left: 5px solid var(--pearson-blue); flex-wrap: wrap;
        }
        .header-item { flex: 1; min-width: 200px; }
        .header-item label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--pearson-blue); }
        select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border-col); border-radius: 4px; font-size: 15px; background: var(--input-bg); color: var(--input-text); }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 15px; background: var(--input-bg); padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-col); }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: 600; color: var(--text-color); }

        /* Main Grid */
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 1024px) { .grid-container { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .grid-container { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); border: 1px solid var(--border-col); border-radius: 6px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Card Header with Timer */
        .card-header { 
            background: var(--pearson-blue); color: var(--bg-color); padding: 8px 12px; border-radius: 4px; 
            margin: -15px -15px 15px -15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1em;
        }
        .timer-btn {
            background: rgba(255,255,255,0.2); color: white; padding: 2px 10px; border-radius: 12px; 
            font-family: monospace; font-size: 0.9em; cursor: pointer; border: 1px solid transparent; 
            transition: all 0.2s; user-select: none;
        }
        [data-theme="dark"] .timer-btn { color: #121212; font-weight: bold; }
        .timer-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .timer-btn.running { background: var(--timer-running); color: var(--timer-text-running); border-color: var(--timer-text-running); animation: pulse 2s infinite; }
        .timer-btn.paused { background: var(--timer-paused); color: var(--timer-text-paused); border-color: var(--timer-text-paused); }
        .timer-btn.ended { background: var(--timer-ended); color: var(--timer-text-ended); border-color: var(--timer-text-ended); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* Task Rows */
        .task-row { margin-bottom: 15px; border-bottom: 1px dashed var(--border-col); padding-bottom: 10px; }
        .task-label { font-weight: 700; margin-bottom: 6px; display: block; font-size: 0.95em; color: var(--text-color); }
        
        /* Buttons */
        .btn-group { display: flex; width: 100%; border: 1px solid var(--border-col); border-radius: 4px; overflow: hidden; }
        .mark-btn { 
            flex: 1; padding: 10px; text-align: center; background: var(--input-bg); color: var(--input-text); cursor: pointer; 
            font-weight: bold; border-right: 1px solid var(--border-col); transition: background 0.1s;
        }
        .mark-btn:last-child { border-right: none; }
        .mark-btn:hover { background: var(--timer-idle); }
        .mark-btn.active { background: var(--pearson-blue); color: var(--bg-color); }

        select.mark-select { background: var(--input-bg); color: var(--input-text); cursor: pointer; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-col); }
        select.mark-select:invalid { color: #888; }

        /* Rubrics */
        details.rubric { margin-top: 8px; }
        details.rubric summary { font-size: 0.85em; color: var(--pearson-blue); cursor: pointer; outline: none; list-style: none; }
        details.rubric summary::-webkit-details-marker { display: none; }
        details.rubric summary::after { content: " ‚ÑπÔ∏è criteria"; font-style: italic; }
        
        .rubric-content { 
            font-size: 0.9em; background: var(--rubric-bg); border: 1px solid var(--border-col); padding: 10px; 
            border-radius: 4px; margin-top: 4px; line-height: 1.4; color: var(--text-color);
        }
        .rubric-content b { color: var(--pearson-blue); display: inline-block; width: 45px; }

        /* Fixed Footer */
        .fixed-footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--footer-bg); border-top: 2px solid var(--pearson-blue);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.15); z-index: 1000; padding: 10px 20px;
        }

        /* Compact Feedback Row */
        .feedback-row { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); 
            scrollbar-width: thin;
        }
        .fb-item { min-width: 140px; flex: 1; }
        .fb-item label { display: block; font-size: 0.75em; font-weight: bold; margin-bottom: 2px; color: var(--pearson-blue); white-space: nowrap; }
        .fb-item select { width: 100%; font-size: 0.85em; padding: 4px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-col); border-radius: 3px; }
        .fb-item-comment { flex: 2; min-width: 200px; }
        .fb-item-comment input { width: 100%; padding: 5px; border: 1px solid var(--border-col); border-radius: 3px; font-size: 0.9em; background: var(--card-bg); color: var(--text-color); }

        /* Controls Row */
        .controls-row { display: flex; justify-content: space-between; align-items: center; }
        .stats-wrapper { display: flex; align-items: center; gap: 15px; }
        .total-display { font-size: 1.4em; font-weight: bold; color: var(--pearson-blue); }
        
        .global-timer {
            background: var(--card-bg); color: var(--pearson-blue); border: 1px solid var(--pearson-blue);
            font-size: 1em; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-family: monospace; font-weight: bold; user-select: none;
        }
        .global-timer:hover { background: var(--timer-idle); }
        .global-timer.running { background: var(--timer-running); color: var(--timer-text-running); border-color: var(--timer-text-running); animation: pulse 2s infinite; }
        .global-timer.paused { background: var(--timer-paused); color: var(--timer-text-paused); border-color: var(--timer-text-paused); }

        .btn-wrapper { display: flex; gap: 10px; }
        button { padding: 8px 20px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.primary { background: var(--pearson-green); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        button.primary:hover { background: #00663f; transform: translateY(-1px); }
        button.secondary { background: var(--btn-sec-bg); color: var(--btn-sec-text); }
        button.secondary:hover { opacity: 0.9; }

        /* Output Table */
        .table-wrapper { margin-top: 40px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; white-space: nowrap; background: white; color: black; }
        th, td { border: 1px solid #999; padding: 8px; text-align: center; }
        th { background-color: var(--th-bg) !important; color: var(--th-text) !important; border-bottom: 2px solid #000; font-weight: bold; }
        tr:nth-child(even) { background: #f3f3f3; }
        .delete-btn { background: var(--pearson-red); color: white; padding: 2px 8px; font-size: 11px; border-radius: 3px; cursor: pointer; border: none; }

        /* Footer Credit */
        footer { 
            text-align: right; margin-top: 40px; padding-top: 10px; border-top: 1px solid var(--border-col); 
            font-size: 0.8em; color: #777; font-style: italic;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        Pearson Edexcel GCSE Speaking Marker
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">‚òÄÔ∏è/üåô</button>
    </h1>

    <details class="setup-panel" id="setupDetails">
        <summary>‚öôÔ∏è Setup: Import Class List (Click to expand)</summary>
        <div style="padding: 10px 0;">
            <label>Paste Candidate List (e.g. from Excel - Name/Number):</label>
            <textarea id="candidateListInput" placeholder="John Smith - 1001&#10;Jane Doe - 1002&#10;..."></textarea>
            <button type="button" class="secondary" onclick="loadClassList()" style="margin-top: 10px;">Load Class List</button>
            <span id="setupMsg" style="margin-left: 10px; color: var(--pearson-green); font-weight: bold;"></span>
        </div>
    </details>
    
    <div class="header-panel">
        <div class="header-item">
            <label>Candidate</label>
            <select id="candidateSelect">
                <option value="">-- Select Candidate --</option>
            </select>
            <input type="text" id="manualCandidate" placeholder="Or type name manually..." style="display:none; margin-top:5px;">
        </div>
        <div class="header-item">
            <label>Exam Tier</label>
            <select id="tierSelect" onchange="changeTier()">
                <option value="Foundation">Foundation Tier</option>
                <option value="Higher">Higher Tier</option>
            </select>
        </div>
        <div class="header-item" style="flex:0;">
            <label>Rubric Display</label>
            <div class="toggle-container">
                <label class="radio-label"><input type="radio" name="rubricMode" id="modeFull" value="full" checked onchange="updateRubrics()"> Full</label>
                <label class="radio-label"><input type="radio" name="rubricMode" id="modeBrief" value="brief" onchange="updateRubrics()"> Brief</label>
            </div>
        </div>
    </div>

    <form id="markForm">
        <div class="grid-container">

            <div class="card">
                <div class="card-header">
                    <span>Task 1: Read Aloud</span> 
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span id="timer_t1" class="timer-btn" onclick="toggleTimer('t1')" ondblclick="resetTimer('t1')">‚è±Ô∏è 0:00</span>
                        <span>12</span>
                    </div>
                </div>
                
                <div class="task-row">
                    <span class="task-label">Read Aloud (AO3) /8</span>
                    <select id="t1_read" class="mark-select" data-name="Task 1 Reading" onchange="calcTotal()">
                        <option value="" disabled selected>- Select -</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
                        <option value="3">3</option><option value="4">4</option><option value="5">5</option>
                        <option value="6">6</option><option value="7">7</option><option value="8">8</option>
                    </select>
                    <details class="rubric">
                        <summary></summary>
                        <div class="rubric-content" id="rubric_t1_read"></div>
                    </details>
                </div>

                <div class="task-row">
                    <span class="task-label">Q1 (AO1) /2</span>
                    <div class="btn-group" id="group_t1_q1">
                        <div class="mark-btn" onclick="setMark('t1_q1', 0, this)">0</div>
                        <div class="mark-btn" onclick="setMark('t1_q1', 1, this)">1</div>
                        <div class="mark-btn" onclick="setMark('t1_q1', 2, this)">2</div>
                    </div>
                    <input type="hidden" id="t1_q1" data-name="Task 1 Q1" value="">
                </div>

                <div class="task-row">
                    <span class="task-label">Q2 (AO1) /2</span>
                    <div class="btn-group" id="group_t1_q2">
                        <div class="mark-btn" onclick="setMark('t1_q2', 0, this)">0</div>
                        <div class="mark-btn" onclick="setMark('t1_q2', 1, this)">1</div>
                        <div class="mark-btn" onclick="setMark('t1_q2', 2, this)">2</div>
                    </div>
                    <input type="hidden" id="t1_q2" data-name="Task 1 Q2" value="">
                    <details class="rubric">
                        <summary></summary>
                        <div class="rubric-content">
                            <b>2:</b> Response fully communicated.<br>
                            <b>1:</b> Response partially communicated, some ambiguity.<br>
                            <b>0:</b> No rewardable communication.
                        </div>
                    </details>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Task 2: Role Play</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span id="timer_t2" class="timer-btn" onclick="toggleTimer('t2')" ondblclick="resetTimer('t2')">‚è±Ô∏è 0:00</span>
                        <span>10</span>
                    </div>
                </div>
                
                <div class="task-row"><span class="task-label">Prompt 1 /2</span>
                    <div class="btn-group" id="group_t2_p1"><div class="mark-btn" onclick="setMark('t2_p1',0,this)">0</div><div class="mark-btn" onclick="setMark('t2_p1',1,this)">1</div><div class="mark-btn" onclick="setMark('t2_p1',2,this)">2</div></div>
                    <input type="hidden" id="t2_p1" data-name="Role Play P1" value="">
                </div>
                <div class="task-row"><span class="task-label">Prompt 2 /2</span>
                    <div class="btn-group" id="group_t2_p2"><div class="mark-btn" onclick="setMark('t2_p2',0,this)">0</div><div class="mark-btn" onclick="setMark('t2_p2',1,this)">1</div><div class="mark-btn" onclick="setMark('t2_p2',2,this)">2</div></div>
                    <input type="hidden" id="t2_p2" data-name="Role Play P2" value="">
                </div>
                <div class="task-row"><span class="task-label">Prompt 3 /2</span>
                    <div class="btn-group" id="group_t2_p3"><div class="mark-btn" onclick="setMark('t2_p3',0,this)">0</div><div class="mark-btn" onclick="setMark('t2_p3',1,this)">1</div><div class="mark-btn" onclick="setMark('t2_p3',2,this)">2</div></div>
                    <input type="hidden" id="t2_p3" data-name="Role Play P3" value="">
                </div>
                <div class="task-row"><span class="task-label">Prompt 4 /2</span>
                    <div class="btn-group" id="group_t2_p4"><div class="mark-btn" onclick="setMark('t2_p4',0,this)">0</div><div class="mark-btn" onclick="setMark('t2_p4',1,this)">1</div><div class="mark-btn" onclick="setMark('t2_p4',2,this)">2</div></div>
                    <input type="hidden" id="t2_p4" data-name="Role Play P4" value="">
                </div>
                <div class="task-row"><span class="task-label">Prompt 5 /2</span>
                    <div class="btn-group" id="group_t2_p5"><div class="mark-btn" onclick="setMark('t2_p5',0,this)">0</div><div class="mark-btn" onclick="setMark('t2_p5',1,this)">1</div><div class="mark-btn" onclick="setMark('t2_p5',2,this)">2</div></div>
                    <input type="hidden" id="t2_p5" data-name="Role Play P5" value="">
                </div>

                <details class="rubric">
                    <summary></summary>
                    <div class="rubric-content">
                        <b>2:</b> Response fully communicated.<br>
                        <b>1:</b> Response partially communicated, some ambiguity.<br>
                        <b>0:</b> No rewardable communication.
                    </div>
                </details>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Task 3: Pic. & Conv.</span> 
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span id="timer_t3" class="timer-btn" onclick="toggleTimer('t3')" ondblclick="resetTimer('t3')">‚è±Ô∏è 0:00</span>
                        <span>28</span>
                    </div>
                </div>
                
                <div class="task-row">
                    <span class="task-label">Pic. Desc. (AO2) /4</span>
                    <select id="t3_pic_ao2" class="mark-select" data-name="Pic Desc AO2" onchange="calcTotal()">
                        <option value="" disabled selected>- Select -</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                    </select>
                    <details class="rubric"><summary></summary><div class="rubric-content" id="rubric_t3_pic_ao2"></div></details>
                </div>
                <div class="task-row">
                    <span class="task-label">Pic. Desc. (AO3) /4</span>
                    <select id="t3_pic_ao3" class="mark-select" data-name="Pic Desc AO3" onchange="calcTotal()">
                        <option value="" disabled selected>- Select -</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                    </select>
                    <details class="rubric"><summary></summary><div class="rubric-content" id="rubric_t3_pic_ao3"></div></details>
                </div>

                <div style="display:flex; gap:10px;">
                    <div class="task-row" style="flex:1;">
                        <span class="task-label">Pic Q1 /2</span>
                        <div class="btn-group" id="group_t3_q1">
                            <div class="mark-btn" onclick="setMark('t3_q1', 0, this)">0</div>
                            <div class="mark-btn" onclick="setMark('t3_q1', 1, this)">1</div>
                            <div class="mark-btn" onclick="setMark('t3_q1', 2, this)">2</div>
                        </div>
                        <input type="hidden" id="t3_q1" data-name="Pic Q1" value="">
                    </div>
                    <div class="task-row" style="flex:1;">
                        <span class="task-label">Pic Q2 /2</span>
                        <div class="btn-group" id="group_t3_q2">
                            <div class="mark-btn" onclick="setMark('t3_q2', 0, this)">0</div>
                            <div class="mark-btn" onclick="setMark('t3_q2', 1, this)">1</div>
                            <div class="mark-btn" onclick="setMark('t3_q2', 2, this)">2</div>
                        </div>
                        <input type="hidden" id="t3_q2" data-name="Pic Q2" value="">
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--border-col); margin: 15px 0;">

                <div class="task-row">
                    <span class="task-label">Conv. (AO1) /12</span>
                    <select id="t3_conv_ao1" class="mark-select" data-name="Conv AO1" onchange="calcTotal()">
                        <option value="" disabled selected>- Select -</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                        <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                    </select>
                    <details class="rubric"><summary></summary><div class="rubric-content" id="rubric_t3_conv_ao1"></div></details>
                </div>
                <div class="task-row">
                    <span class="task-label">Conv. (AO3) /4</span>
                    <select id="t3_conv_ao3" class="mark-select" data-name="Conv AO3" onchange="calcTotal()">
                        <option value="" disabled selected>- Select -</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                    </select>
                    <details class="rubric"><summary></summary><div class="rubric-content" id="rubric_t3_conv_ao3"></div></details>
                </div>
            </div>
        </div>

        <div class="fixed-footer">
            <div class="feedback-row">
                <div class="fb-item">
                    <label>Timeframes</label>
                    <select id="fb_timeframes"><option value="">-</option><option>Consistently successful</option><option>Frequently successful</option><option>Generally successful</option><option>Some success</option><option>Limited success</option></select>
                </div>
                <div class="fb-item">
                    <label>Opinions</label>
                    <select id="fb_opinions"><option value="">-</option><option>Fully justified</option><option>Justifies opinions</option><option>Simple opinions</option><option>Limited/None</option></select>
                </div>
                <div class="fb-item">
                    <label>Interaction</label>
                    <select id="fb_interaction"><option value="">-</option><option>Spontaneous</option><option>Sustains conversation</option><option>Needs prompting</option><option>Rehearsed language</option></select>
                </div>
                <div class="fb-item">
                    <label>Vocab Range</label>
                    <select id="fb_vocab"><option value="">-</option><option>Wide range</option><option>Variety</option><option>Some variety</option><option>Occasional variety</option><option>Limited</option></select>
                </div>
                <div class="fb-item fb-item-comment">
                    <label>Comments</label>
                    <input type="text" id="fb_comments" placeholder="Optional notes...">
                </div>
            </div>

            <div class="controls-row">
                <div class="stats-wrapper">
                    <span class="total-display">Score: <span id="currentTotal">0</span>/50</span>
                    <div id="timer_total" class="timer-btn global-timer" onclick="toggleTimer('total')" ondblclick="resetTimer('total')">‚è±Ô∏è 0:00</div>
                </div>
                <div class="btn-wrapper">
                    <button type="button" class="secondary" onclick="confirmReset()">Clear</button>
                    <button type="button" class="primary" onclick="validateAndSave()">Save</button>
                </div>
            </div>
        </div>
    </form>

    <div class="table-wrapper">
        <div style="padding: 10px; background: var(--header-bg); border-bottom:1px solid var(--border-col); display:flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; color:var(--pearson-blue)">Session Results</h3>
            <button class="secondary" style="padding: 6px 12px; font-size: 13px;" onclick="copyTable()">Copy Table for Excel</button>
        </div>
        <table id="outputTable">
            <thead>
                <tr>
                    <th>Action</th><th>Name</th><th>Tier</th><th>Total</th>
                    <th>T1 Read</th><th>T1 Q1</th><th>T1 Q2</th>
                    <th>T2 P1</th><th>T2 P2</th><th>T2 P3</th><th>T2 P4</th><th>T2 P5</th>
                    <th>T3 Desc AO2</th><th>T3 Desc AO3</th><th>T3 Q1</th><th>T3 Q2</th>
                    <th>T3 Conv AO1</th><th>T3 Conv AO3</th>
                    <th>Timeframes</th><th>Opinions</th><th>Interact</th><th>Vocab</th><th>Comments</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <footer>
        Created by Paul Croft-Cafferty, Homewood School and Sixth Form Centre
    </footer>

</div>

<script>
    // --- RUBRIC DATA ---
    const rubrics = {
        foundation: {
            t1_read: {
                full: `<b>7-8:</b> Pronunciation is generally clear and comprehensible; lapses in SSCs have limited impact on the message.<br><b>5-6:</b> Pronunciation is sometimes clear and comprehensible; lapses in SSCs occasionally makes the message unclear/difficult to understand immediately.<br><b>3-4:</b> Pronunciation is occasionally clear and comprehensible; lapses in SSCs sometimes cause the message to break down.<br><b>1-2:</b> Pronunciation is limited in clarity; lapses in SSCs often cause the message to break down.`,
                brief: `<b>7-8:</b> Generally clear; limited lapses.<br><b>5-6:</b> Sometimes clear; occasionally unclear.<br><b>3-4:</b> Occasionally clear; sometimes breakdown.<br><b>1-2:</b> Limited clarity; often breakdown.`
            },
            t3_pic_ao2: {
                full: `<b>4:</b> Two or more bullet points addressed. Ideas are generally developed, to describe different, relevant aspects of the picture. Response is generally comprehensible; some messages may be unclear.<br><b>3:</b> Two or more bullet points addressed. Some development of ideas to describe different, relevant aspects of the picture. Response is comprehensible in some parts; the message may occasionally break down.<br><b>2:</b> One or more bullet point(s) addressed. Occasional, brief development of ideas to describe different, relevant aspects of the picture. Some parts of the response are comprehensible; the message sometimes breaks down.<br><b>1:</b> One or more bullet point(s) addressed. Little or no development of ideas to describe different, relevant aspects of the picture. Limited parts of the response are comprehensible; the message often breaks down.`,
                brief: `<b>4:</b> 2+ bullets. Generally developed. Generally comprehensible.<br><b>3:</b> 2+ bullets. Some development. Comprehensible in parts.<br><b>2:</b> 1+ bullet. Brief development. Some parts comprehensible.<br><b>1:</b> 1+ bullet. Little/no development. Limited parts comprehensible.`
            },
            t3_pic_ao3: {
                full: `<b>4:</b> Some variety of vocabulary and grammatical structures. Generally accurate use of language; some minor errors, there may be an occasional major error.<br><b>3:</b> Occasional variety of vocabulary and grammatical structures. Some accurate language; errors occur, some of them major.<br><b>2:</b> Limited variety of vocabulary and grammatical structures. Limited accuracy in the language; frequent errors both major and minor.<br><b>1:</b> Minimal variety of vocabulary and grammatical structures. Minimal accuracy in the language; errors throughout, most of them major.`,
                brief: `<b>4:</b> Some variety. Generally accurate.<br><b>3:</b> Occasional variety. Some accurate (some major errors).<br><b>2:</b> Limited variety. Limited accuracy (freq errors).<br><b>1:</b> Minimal variety. Minimal accuracy.`
            },
            t3_conv_ao1: {
                full: `<b>10-12:</b> Gives some relevant responses to questions. Develops ideas with some extended sequences of speech. Response is generally comprehensible; some messages may be unclear.<br><b>7-9:</b> Gives occasional relevant responses to questions. Develops ideas with occasionally extended sequences of speech. Response is comprehensible in some parts; the message may occasionally break down.<br><b>4-6:</b> Gives limited relevant responses to questions; there may be times when the speaker is unable to respond. Development of ideas is limited; brief responses which the speaker may not be able to sustain. Limited parts of the response are comprehensible; the message sometimes breaks down.<br><b>1-3:</b> Gives minimal relevant responses to questions; often not able to respond/relies on rehearsed language that is irrelevant. Little or no development of ideas; very brief responses. Isolated parts of the response are comprehensible; the message frequently breaks down.`,
                brief: `<b>10-12:</b> Some relevant responses. Some extended speech. Generally comprehensible.<br><b>7-9:</b> Occasional relevant/extended. Comprehensible in parts.<br><b>4-6:</b> Limited responses. Limited development.<br><b>1-3:</b> Minimal responses.`
            },
            t3_conv_ao3: {
                full: `<b>4:</b> Some variety of vocabulary and grammatical structures, occasional use of complex language. Generally successful use of three timeframes. Generally accurate use of language; some minor errors, there may be an occasional major error.<br><b>3:</b> Occasional variety of vocabulary and straightforward grammatical structures. Some successful use of at least two timeframes, occasional slip in more complex constructions. Some clear and accurate use of language; some major and minor errors.<br><b>2:</b> Limited variety of vocabulary and straightforward grammatical structures, likely to be repetitive. Limited success with timeframes. Limited accuracy with language; many major and minor errors.<br><b>1:</b> Minimal variety of vocabulary, likely to use individual words and/or phrases in isolation. Minimal success with timeframes. Minimal accuracy in the language; errors throughout, both major and minor.`,
                brief: `<b>4:</b> Some variety/complex. 3 timeframes successful. Generally accurate.<br><b>3:</b> Occasional variety. 2 timeframes successful. Some accuracy.<br><b>2:</b> Limited variety/timeframes/accuracy.<br><b>1:</b> Minimal variety/timeframes/accuracy.`
            }
        },
        higher: {
            t1_read: {
                full: `<b>7-8:</b> Pronunciation is consistently clear and comprehensible, any lapses in SSCs have no impact on the message.<br><b>5-6:</b> Pronunciation is clear and comprehensible, lapses in SSCs have minimal impact on the message.<br><b>3-4:</b> Pronunciation is generally clear and comprehensible; lapses in SSCs have limited impact on the message.<br><b>1-2:</b> Pronunciation is sometimes clear and comprehensible; lapses in SSCs occasionally makes the message unclear/difficult to understand immediately.`,
                brief: `<b>7-8:</b> Consistently clear; lapses no impact.<br><b>5-6:</b> Clear; lapses minimal impact.<br><b>3-4:</b> Generally clear; lapses limited impact.<br><b>1-2:</b> Sometimes clear; lapses occasionally unclear.`
            },
            t3_pic_ao2: {
                full: `<b>4:</b> All three bullet points addressed. Consistent, detailed development of ideas to describe different, relevant aspects of the picture. Response is easily comprehensible; it is rare that the message is not immediately clear.<br><b>3:</b> All three bullet points addressed. Frequent development of ideas, some of which is detailed, to describe different, relevant aspects of the picture. Response is comprehensible; the occasional message may be unclear/difficult to understand immediately.<br><b>2:</b> Two or more bullet points addressed. Ideas are generally developed, to describe different, relevant aspects of the picture. Response is generally comprehensible; some messages may be unclear.<br><b>1:</b> Two or more bullet points addressed. Some development of ideas to describe different, relevant aspects of the picture. Response is comprehensible in some parts; the message may occasionally break down.`,
                brief: `<b>4:</b> 3 bullets. Consistent/detailed dev. Easily comprehensible.<br><b>3:</b> 3 bullets. Frequent dev. Comprehensible (occ. unclear).<br><b>2:</b> 2+ bullets. Generally developed. Generally comprehensible.<br><b>1:</b> 2+ bullets. Some development. Comprehensible in parts.`
            },
            t3_pic_ao3: {
                full: `<b>4:</b> Wide range of relevant vocabulary and grammatical structures. Consistently accurate use of language, any errors are minor.<br><b>3:</b> A variety of relevant vocabulary and grammatical structures. Mostly accurate use of language; some minor errors.<br><b>2:</b> Some variety of vocabulary and grammatical structures. Generally accurate use of language; some minor errors, there may be an occasional major error.<br><b>1:</b> Occasional variety of vocabulary and grammatical structures. Some accurate language; errors occur, some of them major.`,
                brief: `<b>4:</b> Wide range. Consistently accurate.<br><b>3:</b> Variety. Mostly accurate.<br><b>2:</b> Some variety. Generally accurate.<br><b>1:</b> Occasional variety. Some accurate.`
            },
            t3_conv_ao1: {
                full: `<b>10-12:</b> Gives consistently relevant responses to questions. Develops ideas throughout with consistently extended sequences of speech. Response is easily comprehensible; it is rare that the message is not immediately clear.<br><b>7-9:</b> Gives frequently relevant responses to questions. Develops ideas with frequently extended sequences of speech. Response is comprehensible; the occasional message may be unclear/difficult to understand immediately.<br><b>4-6:</b> Gives some relevant responses to questions. Develops ideas with some extended sequences of speech. Response is generally comprehensible; some messages may be unclear.<br><b>1-3:</b> Gives occasional relevant responses to questions. Develops ideas with occasionally extended sequences of speech. Response is comprehensible in some parts; the message may occasionally break down.`,
                brief: `<b>10-12:</b> Consistently relevant/extended. Easily comprehensible.<br><b>7-9:</b> Frequently relevant/extended.<br><b>4-6:</b> Some relevant. Some extended. Generally comprehensible.<br><b>1-3:</b> Occasional relevant/extended. Comprehensible in parts.`
            },
            t3_conv_ao3: {
                full: `<b>4:</b> Wide range of vocabulary and grammatical structures, frequent use of complex language. Consistently successful use of three timeframes. Consistently accurate use of language, any errors are minor.<br><b>3:</b> A variety of vocabulary and grammatical structures, some use of complex language. Frequently successful use of at least two timeframes. Accurate use of language; some minor errors.<br><b>2:</b> Some variety of vocabulary and grammatical structures, occasional use of complex language. Generally successful use of at least two timeframes. Generally accurate use of language; some minor errors, there may be an occasional major error.<br><b>1:</b> Occasional variety of vocabulary and straightforward grammatical structures. Some successful use of timeframes, occasional slip in more complex constructions. Some clear and accurate use of language; some major and minor errors.`,
                brief: `<b>4:</b> Wide range vocab/complex. 3 timeframes successful. Consistently accurate.<br><b>3:</b> Variety vocab/some complex. Freq successful 2+ timeframes. Accurate.<br><b>2:</b> Some variety/occasional complex. Generally successful 2+ timeframes. Generally accurate.<br><b>1:</b> Occasional variety. Some successful timeframes. Some clear/accurate.`
            }
        }
    };

    // --- TIMERS ---
    const timeLimits = {
        foundation: { t1: 120, t2: 90, t3: 330, total: 540 }, 
        higher: { t1: 150, t2: 90, t3: 480, total: 720 }
    };
    
    let timers = {
        t1: { interval: null, remaining: 0, default: 0, running: false },
        t2: { interval: null, remaining: 0, default: 0, running: false },
        t3: { interval: null, remaining: 0, default: 0, running: false },
        total: { interval: null, remaining: 0, default: 0, running: false }
    };

    function toggleTheme() {
        if (document.body.dataset.theme === "dark") {
            document.body.dataset.theme = "light";
        } else {
            document.body.dataset.theme = "dark";
        }
    }

    function changeTier() {
        updateRubrics();
        resetAllTimers();
    }

    function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function resetAllTimers() {
        const tier = document.getElementById('tierSelect').value.toLowerCase();
        const limits = timeLimits[tier];
        
        ['t1', 't2', 't3', 'total'].forEach(key => {
            clearInterval(timers[key].interval);
            timers[key].default = limits[key];
            timers[key].remaining = limits[key];
            timers[key].running = false;
            updateTimerDisplay(key);
        });
    }

    function updateTimerDisplay(id) {
        const el = document.getElementById('timer_' + id);
        let prefix = id === 'total' ? '‚è±Ô∏è ' : '‚è±Ô∏è '; 
        el.innerText = prefix + formatTime(timers[id].remaining);
        
        el.classList.remove('running', 'paused', 'ended');
        
        if (timers[id].remaining === 0) {
            el.classList.add('ended');
        } else if (timers[id].running) {
            el.classList.add('running');
        } else if (timers[id].remaining < timers[id].default) {
            el.classList.add('paused');
        }
    }

    function toggleTimer(id) {
        if (timers[id].running) {
            clearInterval(timers[id].interval);
            timers[id].running = false;
        } else {
            if (timers[id].remaining <= 0) return;
            timers[id].running = true;
            timers[id].interval = setInterval(() => {
                timers[id].remaining--;
                if (timers[id].remaining <= 0) {
                    clearInterval(timers[id].interval);
                    timers[id].running = false;
                }
                updateTimerDisplay(id);
            }, 1000);
        }
        updateTimerDisplay(id);
    }

    function resetTimer(id) {
        clearInterval(timers[id].interval);
        timers[id].remaining = timers[id].default;
        timers[id].running = false;
        updateTimerDisplay(id);
    }

    // --- SETUP & INIT ---
    window.onload = function() {
        updateRubrics();
        resetAllTimers();
    };

    function loadClassList() {
        const txt = document.getElementById('candidateListInput').value;
        if(!txt.trim()) {
            document.getElementById('manualCandidate').style.display = "block";
            document.getElementById('candidateSelect').style.display = "none";
            return;
        }
        
        const names = txt.split('\n').filter(l => l.trim().length > 0);
        const sel = document.getElementById('candidateSelect');
        sel.innerHTML = '<option value="">-- Select Candidate --</option>';
        names.forEach(n => {
            let opt = document.createElement('option');
            opt.value = n;
            opt.innerText = n;
            sel.appendChild(opt);
        });
        
        document.getElementById('candidateSelect').style.display = "block";
        document.getElementById('manualCandidate').style.display = "none";
        document.getElementById('setupMsg').innerText = "Loaded " + names.length + " candidates.";
        document.getElementById('setupDetails').removeAttribute("open");
    }

    // --- MARKING LOGIC ---
    function updateRubrics() {
        const tier = document.getElementById('tierSelect').value.toLowerCase();
        const mode = document.querySelector('input[name="rubricMode"]:checked').value; 
        const d = rubrics[tier];
        
        if (d) {
            document.getElementById('rubric_t1_read').innerHTML = d.t1_read[mode];
            document.getElementById('rubric_t3_pic_ao2').innerHTML = d.t3_pic_ao2[mode];
            document.getElementById('rubric_t3_pic_ao3').innerHTML = d.t3_pic_ao3[mode];
            document.getElementById('rubric_t3_conv_ao1').innerHTML = d.t3_conv_ao1[mode];
            document.getElementById('rubric_t3_conv_ao3').innerHTML = d.t3_conv_ao3[mode];
        }
    }

    function setMark(id, val, btn) {
        document.getElementById(id).value = val;
        let group = btn.parentElement;
        Array.from(group.children).forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        calcTotal();
    }

    function calcTotal() {
        let total = 0;
        const selects = ['t1_read', 't3_pic_ao2', 't3_pic_ao3', 't3_conv_ao1', 't3_conv_ao3'];
        selects.forEach(id => {
            let v = document.getElementById(id).value;
            if(v !== "") total += parseInt(v);
        });
        const hiddens = ['t1_q1', 't1_q2', 't2_p1', 't2_p2', 't2_p3', 't2_p4', 't2_p5', 't3_q1', 't3_q2'];
        hiddens.forEach(id => {
            let v = document.getElementById(id).value;
            if(v !== "") total += parseInt(v);
        });
        
        document.getElementById('currentTotal').innerText = total;
        return total;
    }

    function validateAndSave() {
        let name = document.getElementById('candidateSelect').value;
        if(!name) name = document.getElementById('manualCandidate').value;
        if(!name) { alert("Please enter/select a candidate name."); return; }

        let missing = [];
        const allIds = [
            't1_read', 't1_q1', 't1_q2',
            't2_p1', 't2_p2', 't2_p3', 't2_p4', 't2_p5',
            't3_pic_ao2', 't3_pic_ao3', 't3_q1', 't3_q2', 't3_conv_ao1', 't3_conv_ao3'
        ];

        allIds.forEach(id => {
            let el = document.getElementById(id);
            if(el.value === "") {
                let parent = el.closest('.task-row');
                let label = parent ? parent.querySelector('.task-label').innerText : id;
                label = label.replace(/\s\/.*/, '');
                missing.push("- " + label);
            }
        });

        if(missing.length > 0) {
            let msg = "‚ö†Ô∏è You have not marked:\n\n" + missing.join("\n") + "\n\nSave anyway?";
            if(!confirm(msg)) return;
        }

        addToTable(name);
    }

    function addToTable(name) {
        const tier = document.getElementById('tierSelect').value;
        const total = document.getElementById('currentTotal').innerText;
        const tbody = document.querySelector('#outputTable tbody');
        const tr = document.createElement('tr');

        const gv = (id) => document.getElementById(id).value;

        const data = [
            gv('t1_read'), gv('t1_q1'), gv('t1_q2'),
            gv('t2_p1'), gv('t2_p2'), gv('t2_p3'), gv('t2_p4'), gv('t2_p5'),
            gv('t3_pic_ao2'), gv('t3_pic_ao3'), gv('t3_q1'), gv('t3_q2'),
            gv('t3_conv_ao1'), gv('t3_conv_ao3'),
            document.getElementById('fb_timeframes').value,
            document.getElementById('fb_opinions').value,
            document.getElementById('fb_interaction').value,
            document.getElementById('fb_vocab').value,
            document.getElementById('fb_comments').value
        ];

        let tdAction = document.createElement('td');
        let btn = document.createElement('button');
        btn.innerHTML = "X";
        btn.className = "delete-btn";
        btn.onclick = function() { if(confirm("Are you sure?")) this.closest('tr').remove(); };
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        let tdName = document.createElement('td'); tdName.innerText = name; tr.appendChild(tdName);
        let tdTier = document.createElement('td'); tdTier.innerText = tier; tr.appendChild(tdTier);
        let tdTotal = document.createElement('td'); tdTotal.innerText = total; tdTotal.style.fontWeight="bold"; tdTotal.style.color="var(--pearson-blue)"; tr.appendChild(tdTotal);

        data.forEach(d => {
            let td = document.createElement('td');
            td.innerText = (d === "") ? "-" : d;
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
        resetForm();
    }

    function confirmReset() {
        if(confirm("Are you sure? Unsaved data will be lost.")) resetForm();
    }

    function resetForm() {
        document.querySelectorAll('select.mark-select').forEach(s => s.value = "");
        document.querySelectorAll('input[type="hidden"]').forEach(i => i.value = "");
        document.querySelectorAll('.mark-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('fb_comments').value = "";
        
        // Reset Feedback Dropdowns
        document.getElementById('fb_timeframes').value = "";
        document.getElementById('fb_opinions').value = "";
        document.getElementById('fb_interaction').value = "";
        document.getElementById('fb_vocab').value = "";

        document.getElementById('candidateSelect').value = "";
        document.getElementById('manualCandidate').value = "";
        document.getElementById('currentTotal').innerText = "0";
        
        resetAllTimers();
        window.scrollTo(0,0);
    }

    function copyTable() {
        const el = document.getElementById('outputTable');
        const range = document.createRange();
        range.selectNode(el);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        alert("Table copied!");
    }

    window.addEventListener('beforeunload', function (e) {
        if (document.querySelector('#outputTable tbody').children.length > 0) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

</script>

</body>
</html>
